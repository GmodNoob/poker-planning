# GitLab CI/CD Configuration for Poker Planning
image: docker.internal.scaleway.com/node:22.16.0-alpine

# Pipeline stages definition
stages:
  - install
  - lint
  - test
  - build
  - docker
  - deploy

# Global cache to speed up builds
cache:
  key:
    files:
      - pnpm-lock.yaml
  paths:
    - .pnpm-store
    - node_modules/

# Global variables
variables:
  PNPM_HOME: ".pnpm-store"
  CI: "true"
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE
  # Override team members via env var (comma-separated)
  # VITE_TEAM_MEMBERS: "Alice,Bob,Charlie"

# Default tags for all jobs
default:
  tags:
    - front-website
    - docker

# Job: Install dependencies
install:
  stage: install
  before_script:
    - corepack enable
    - corepack prepare pnpm@10.17.0 --activate
    - pnpm config set store-dir .pnpm-store
  script:
    - pnpm install --frozen-lockfile
  artifacts:
    paths:
      - node_modules/
      - .pnpm-store/
    expire_in: 1 hour
  only:
    - branches
    - tags
    - merge_requests

# Job: Linting and code verification
lint:
  stage: lint
  needs: [install]
  before_script:
    - corepack enable
    - corepack prepare pnpm@10.17.0 --activate
  script:
    - pnpm exec tsc --noEmit
  allow_failure: false
  only:
    - branches
    - tags
    - merge_requests

# Job: E2E tests with Playwright
test:e2e:
  stage: test
  needs: [install]
  image: mcr.microsoft.com/playwright:v1.56.1-noble
  before_script:
    - corepack enable
    - corepack prepare pnpm@10.17.0 --activate
    - pnpm config set store-dir .pnpm-store
  script:
    # Install dependencies if necessary
    - pnpm install --frozen-lockfile

    # Start SSE server in background
    - pnpm run dev:server &
    - SERVER_PID=$!

    # Start Vite in background
    - pnpm run dev &
    - VITE_PID=$!

    # Wait for servers to start
    - sleep 10

    # Verify that servers are running
    - wget --spider --tries=30 --retry-connrefused http://localhost:3001/state || exit 1
    - wget --spider --tries=30 --retry-connrefused http://localhost:5173 || exit 1

    # Run tests
    - pnpm test

    # Stop servers
    - kill $SERVER_PID $VITE_PID || true
  artifacts:
    when: always
    paths:
      - playwright-report/
      - test-results/
    reports:
      junit: test-results/junit.xml
    expire_in: 30 days
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  only:
    - branches
    - tags
    - merge_requests

# Job: Production build
build:
  stage: build
  needs: [install, lint]
  before_script:
    - corepack enable
    - corepack prepare pnpm@10.17.0 --activate
    - pnpm config set store-dir .pnpm-store
  script:
    - pnpm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  only:
    - main
    - tags
    - merge_requests

# Job: Build Docker image
docker:build:
  stage: docker
  needs: [build, test:e2e]
  image: docker.internal.scaleway.com/docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build --target production -t $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA -t $DOCKER_IMAGE:latest .
    - docker push $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $DOCKER_IMAGE:latest
  only:
    - main
    - tags

# Job: Build Docker image for tags (with version)
docker:build:tag:
  stage: docker
  needs: [build, test:e2e]
  image: docker.internal.scaleway.com/docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build --target production -t $DOCKER_IMAGE:$CI_COMMIT_TAG .
    - docker push $DOCKER_IMAGE:$CI_COMMIT_TAG
  only:
    - tags

# Job: Deploy Preview for MRs
deploy:preview:
  stage: deploy
  needs: [build]
  before_script:
    - echo "Deploying preview environment"
  script:
    - echo "Preview URL would be available here"
    - echo "This is where you would deploy to a preview environment"
  environment:
    name: preview/mr-$CI_MERGE_REQUEST_IID
    url: https://preview-$CI_MERGE_REQUEST_IID.example.com
    on_stop: stop:preview
    auto_stop_in: 1 week
  only:
    - merge_requests
  when: manual

# Job: Stop preview environment
stop:preview:
  stage: deploy
  before_script:
    - echo "Stopping preview environment"
  script:
    - echo "Cleanup preview deployment"
  environment:
    name: preview/mr-$CI_MERGE_REQUEST_IID
    action: stop
  only:
    - merge_requests
  when: manual

# Job: Deploy to staging
deploy:staging:
  stage: deploy
  needs: [docker:build]
  before_script:
    - echo "Deploying to staging"
  script:
    - echo "Deploy Docker image $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA to staging"
  environment:
    name: staging
    url: https://staging.example.com
  only:
    - main
  when: manual

# Job: Deploy to production
deploy:production:
  stage: deploy
  needs: [docker:build:tag]
  before_script:
    - echo "Deploying to production"
  script:
    - echo "Deploy Docker image $DOCKER_IMAGE:$CI_COMMIT_TAG to production"
  environment:
    name: production
    url: https://poker-planning.example.com
  only:
    - tags
  when: manual

# Job: Security audit
security:audit:
  stage: test
  needs: [install]
  before_script:
    - corepack enable
    - corepack prepare pnpm@10.17.0 --activate
  script:
    - pnpm audit --audit-level=moderate
  allow_failure: true
  only:
    - schedules
    - main
    - merge_requests

# Job: Dependency update check
dependency:check:
  stage: test
  needs: [install]
  before_script:
    - corepack enable
    - corepack prepare pnpm@10.17.0 --activate
  script:
    - pnpm outdated || true
  artifacts:
    reports:
      dependency_scanning: gl-dependency-scanning-report.json
    expire_in: 7 days
  allow_failure: true
  only:
    - schedules
    - main